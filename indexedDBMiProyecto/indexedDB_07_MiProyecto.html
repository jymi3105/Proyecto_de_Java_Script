<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>indexedDB_07 - Crear índices</title>
	<link rel="icon" type="image/x-icon" href="recursos/favicon.ico">
</head>

<body>
	<h1>indexedDB_07 - Crear índices</h1>
	<h2>No debe estar creada la base de datos</h2>
	<h2>Ver consola</h2>
	<hr />

	<button onclick="crearIndicesBD();">Crear índices en los almacenes</button>
	<br />
	<textarea id="info" cols="80" rows="5"></textarea>
	<br />
	<h2>Busqueda de la plaga por id:</h2>
	id de la plaga<input type="number" id="idPlaga" /><br />
	<button onclick="obtenerDatos();">OBTENER DATOS</button>
	<h3>get</h3>
	<p id="datosGet"></p>

	<hr />

	<h3>getKey</h3>
	<p id="datosGetKey"></p>

	<script type="text/javascript">

		var peticion, bd;

		function mensaje(texto) {
			document.getElementById("info").value += "\n\n" + texto;
		}

		function crearIndicesBD() {
			var peticion, bd, almacenPlagas;

			if (window.indexedDB) {
				peticion = window.indexedDB.open("plagasBD", 1);

				peticion.onsuccess = function (evento) {
					//Escribir el código para realizar consultas, inserciones, etc...(DML)
					mensaje("EVENTO: success\nSe ha abierto correctamente la base de datos: " + peticion.result.name + " con versión " + peticion.result.version);

					bd = peticion.result;
					var transaccion = bd.transaction(bd.objectStoreNames, "readwrite");

					almacenPlagas = transaccion.objectStore("plagas");
					almacenPlagas.put({ id: 1, nComun: "blanquilla del chopo", nCientifico: "Leucoma salicis", oCuarentena: "NO", hospedante: "Populus", tFitosanitario: "AZUFRE 80%", imagenAdulto: "Material/Fotos_Adultos/Leucoma_adulto.jpg", imagenLarva: "Material/fotos_Larvas/Leucoma_larva.jpg" });
					almacenPlagas.put({ id: 2, nComun: "longicornio del pino", nCientifico: "Monochamus galloprovincialis", oCuarentena: "SI", hospedante: "Pinus", tFitosanitario: " OXIDO CUPROSO 50%", imagenAdulto: "Material/Fotos_Adultos/Monochamus_adulto.jpg", imagenLarva: "Material/fotos_Larvas/Monochamus_Larvas.png" });
					almacenPlagas.put({ id: 3, nComun: "mosca sierra del pino", nCientifico: "Diprion pini", oCuarentena: "NO", hospedante: "Pinus", tFitosanitario: " BENFLURALINA 18%", imagenAdulto: "Material/Fotos_Adultos/diprion_adulto.jpg", imagenLarva: "Material/fotos_Larvas/Diprion_larva.jpg" });
					almacenPlagas.put({ id: 4, nComun: "piral del roble", nCientifico: "Tortrix viridiana", oCuarentena: "NO", hospedante: "Quercus", tFitosanitario: "AZUFRE 80%", imagenAdulto: "Material/Fotos_Adultos/Tortrix_adulto.jpg", imagenLarva: "Material/fotos_Larvas/Tortrix_larva.jpg" });
					almacenPlagas.put({ id: 5, nComun: "lagarta peluda", nCientifico: "Limantria dispar", oCuarentena: "NO", hospedante: "Quercus", tFitosanitario: "Captan 80%", imagenAdulto: "Material/Fotos_Adultos/limantria_adulto.jpg", imagenLarva: "Material/fotos_Larvas/limantria_larva.jpg" });
					almacenPlagas.put({ id: 6, nComun: "cochinilla de los pinos", nCientifico: "Leucaspis pini", oCuarentena: "NO", hospedante: "Pinus", tFitosanitario: "FOSMET 20%", imagenAdulto: "Material/Fotos_Adultos/LeucaspisPini_adulto.jpg", imagenLarva: "Material/fotos_Larvas/Leucaspis_larva.png" });
					almacenPlagas.put({ id: 7, nComun: "gran capricornio", nCientifico: "Cerambix cerdo", oCuarentena: "NO", hospedante: "Quercus", tFitosanitario: "AZUFRE 80%", imagenAdulto: "Material/Fotos_Adultos/cerambixCerdo_adulto.jpg", imagenLarva: "Material/fotos_Larvas/cerambyx_cerdo_larva.jpg" });
					almacenPlagas.put({ id: 8, nComun: "mariposa lagarta cola parda", nCientifico: "Euproctis chrysorrhoea", oCuarentena: "NO", hospedante: "Salix", tFitosanitario: "METALDEHIDO 5%", imagenAdulto: "Material/Fotos_Adultos/Euproctis chrysorrhoea_adulto.jpg", imagenLarva: "Material/fotos_Larvas/Euproctis chrysorrhoea_larva.jpg" });
					almacenPlagas.put({ id: 9, nComun: "procesionaria del pino", nCientifico: "Thaumetopoea pityocampa", oCuarentena: "NO", hospedante: "Pinus", tFitosanitario: "METALDEHIDO 5%", imagenAdulto: "Material/Fotos_Adultos/procesionariaAdulto.jpg", imagenLarva: "Material/fotos_Larvas/procesionaria1.png" });
					almacenPlagas.put({ id: 10, nComun: "chinche americana de las piñas", nCientifico: "Leptoglossus occidentalis", oCuarentena: "SI", hospedante: "Pinus", tFitosanitario: "FOSMET 20%", imagenAdulto: "Material/Fotos_Adultos/Leptoglosus_adulto.jpg", imagenLarva: "Material/fotos_Larvas/Leptoglosus_larva.jpg" });
					almacenPlagas.put({ id: 11, nComun: "escarabajo rojo del chopo", nCientifico: "Chrysomela populi", oCuarentena: "NO", hospedante: "Populus", tFitosanitario: "Captan 80%", imagenAdulto: "Material/Fotos_Adultos/Chrysomela_adulto.jpg", imagenLarva: "Material/fotos_Larvas/Chrysomela_larva.jpg" });
					almacenPlagas.put({ id: 12, nComun: "gorgojo perforador del chopo", nCientifico: "Cryptorhynchus lapathi", oCuarentena: "NO", hospedante: "Populus", tFitosanitario: " OXIDO CUPROSO 50%", imagenAdulto: "Material/Fotos_Adultos/Chrysomela_adulto.jpg", imagenLarva: "Material/fotos_Larvas/Cryptorhynchus_Larva.jpg" });

				};


				peticion.onerror = function (evento) {
					alert("No se ha creado la base de datos: " + event.target.errorCode);
				};


				peticion.onupgradeneeded = function (evento) {
					//Escribir el código para crear o modificar la estructura de la BD (DDL)
					//Recordatorio: Este evento sólo se ejecuta si se abre la base de datos con una versión nueva superior

					mensaje("EVENTO: upgradedneeded\nSe modifica la versión o es nueva");
					bd = peticion.result;

					almacenPlagas = bd.createObjectStore("plagas", { keyPath: "id" });


					mensaje("SE CREAN LOS ÍNDICES");

					almacenPlagas.createIndex("por_ncom", "nComun", { unique: true });
					almacenPlagas.createIndex("por_ncien", "nCientifico", { unique: true });
					almacenPlagas.createIndex("por_huesped", "hospedante");

				};
			} else {
				console.log("IndexedDB no está soportado");
			}
		}

		function obtenerDatos() {
			var peticion, transaccion, idPlaga;
			idPlaga = document.getElementById("idPlaga").value;
			if (window.indexedDB) {
				if (idPlaga != "") {
					//Si ese input no esta vacio, que habra la base de datos ya existente
					peticion = window.indexedDB.open("plagasBD");

					peticion.onsuccess = function (event) {
						bd = peticion.result;
						//Si tenemos exito a la hora de abrir la bsae de datos, abrimos la transaccion
						//para poder leer en la base de datos
						transaccion = bd.transaction(bd.objectStoreNames, "readwrite");

						transaccion.oncomplete = function (evento) {
							console.log("Consulta terminada")
						};
						//declaramos que la transaccion la vamos a realizar sobre la tabla libros
						almacenPlagas = transaccion.objectStore("plagas");

						//USAMOS GET
						var registro1 = almacenPlagas.get(parseInt(idPlaga));
						registro1.onsuccess = function (event) {
							var c = "";
							c += "<br />Id: " + registro1.result.id;
							c += "<br />Nombre comun: " + registro1.result.nComun;
							c += "<br />Nombre Cientifico: " + registro1.result.nCientifico;
							c += "<br />Organismo de cuarentena: " + registro1.result.oCuarentena;
							c += "<br />Familia hospedante: " + registro1.result.hospedante;
							document.getElementById("datosGet").innerHTML = c;
						}


						//USAMOS GETKEY
						var registro2 = almacenPlagas.getKey(parseInt(idPlaga));
						registro2.onsuccess = function (evento) {
							var c = "";
							c += "<br />" + registro2.result;
							document.getElementById("datosGetKey").innerHTML = c;
						}

						//SE CIERRA LA BASE DE DATOS
						bd.close();
					};

					peticion.onerror = function (evento) {
						alert("No se ha creado la base de datos: " + event.target.errorCode);
					};
				} else {
					alert("Introduce un valor");
				}
			} else {
				console.log("IndexedDB no está soportado");
			}
		}

	</script>
</body>

</html>